Title:	 nss_ndb
Version: 1.0.19
Author:  Peter Eriksson <pen@lysator.liu.se>
Date:    2020-05-27


DESCRIPTION

This project consists of a NSS module (/usr/lib/nss_ndb.so.1) and a CLI
utility (/usr/bin/makendb) that enables big passwd & group files to be
handled efficiently via BTree databases stored in /var/db/nss_ndb/.

Enable via the "ndb" keyword in /etc/nsswitch.conf

Currently this project only supports FreeBSD (tested on 11 & 12).

It is currently in production use at a site with about 120 000 users in
the passwd database and 2000+ groups (some huge) and effectively handles that.

% /usr/bin/time getent passwd | wc -l
        0.63 real         0.36 user         0.26 sys
  129272


DOWNLOADS

The source code for this project can be downloaded from:

    https://github.com/ptrrkssn/nss_ndb


BUILD

By default it will build and install the library and the binaries into
/usr/local/{lib,bin,sbin} but you probably want it to install into
/usr/{lib,bin,sbin} so it will be available early on during system boot
in case /usr/local is on a filesystem not mounted directly.

The "PREFIX" variable in the Makefile can be used to specify alternative
installation locations (defaults to /usr/local)

The database should be kept in /var/db/nss_ndb, but can be relocated via
the "DBDIR" variable in the Makefile

To compile run:

  make PREFIX=/usr

To install into /usr/lib, /usr/bin & /usr/bin, use:

  make PREFIX=/usr install

In order to make "nsswitch" use the newly installed "nss_ndb.so.VERSION" run:

  make PREFIX=/usr install-nsslink


TESTING

First make sure you have created the database files in /var/db/nss_ndb and
populated them with data.

Then run (replace 'some-user-in-the-ndb-database' first):

  make TESTUSER=some-user-in-the-ndb-database check-ndb

This will use the "nsstest" tool and then run a number of validation tests on
the code.


MORE TESTING

Make sure ndb is activated in /etc/nsswitch.conf then some more complete tests
can be done via:

  make TESTUSER=some-user check

To run the same tests under the 'valgrind' memory leak/test tool do:

  make TESTUSER=some-user valgrind



USAGE

1. Create the /var/db/nss_ndb directory:

   mkdir /var/db/nss_ndb
   
2. Populate passwd and groups databases from some source:

   makendb -T passwd /var/db/nss_ndb/passwd </etc/master.passwd
   makendb -T group /var/db/nss_ndb/group </etc/group

3. Add the "ndb" keyword to /etc/nsswitch.conf, for example like this:

   passwd: files ndb
   group:  files ndb

All done. You can dump the contents of the databases with:

  makendb -p path-to-database
  
You can also use the perl script "ndbsync" to sync the NDB databases with data
from an SQL database (mysql) if you would have such a data source.



NDB DATABASE FORMAT

All tables use UTF8.

passwd.byname (user:password:uid:gid:class:change:expire:gecos:home:shell\0):
  Key:
    annda757
  Data:
    annda757:*:1000000036:100000000::0:0:Ann-Sofi Danielsson:/home/annda757:/bin/sh^@

passwd.byuid (user:password:uid:gid:class:change:expire:gecos:home:shell\0):
  Key:
    1000000036
  Data:
    annda757:*:1000000036:100000000::0:0:Ann-Sofi Danielsson:/home/annda757:/bin/sh^@

group.byname (group:password:gid:user,user,user,...\0):
  Key:
    wheel
  Data:
    wheel:*:0:root,Lpeter86,Lmikha02,Ljeamo93,fsAdm,Ldavby02^@

group.bygid (group:password:gid:user,user,user,...\0):
  Key:
    0
  Data:
    wheel:*:0:root,Lpeter86,Lmikha02,Ljeamo93,fsAdm,Ldavby02^@

group.byuser (user:uid:gid,gid,gid,...\0):
  Key (user):
    peter86
  Data:
    peter86:1003258,100,101,102^@


ENVIRONMENT VARIABLES

  NSS_NDB_STRIP_NAMES
    If set, controls if "workgroup" (WORKGROUP\user) and/or Kerberos "realm" (user@realm) parts
    of user names and groups are stripped before matching users in the NDB database

    Valid values:
      yes | both   Removes both parts
      workgroup	   Removes the workgroup part
      realm	   Removes the realm part
      workgroup=WG Removes the workgroup part for specific workgroups only
      realm=RN     Removes the realm part for specific realms only
